<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <template id="assets_frontend" inherit_id="website.assets_frontend" name="Contract Manager">
      <xpath expr="." position="inside">
          <link rel='stylesheet' href='/website_contract/static/src/css/website_contract.less'/>
      </xpath>
    </template>

    <template id="contract" name="Contracts">
        <t t-call="website.layout">
            <div id="wrap">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-4">
                            <ol class="breadcrumb">
                                <li><a href="/account">My Account</a></li>
                                <li>Contract <t t-esc="account.name"/></li>
                            </ol>
                        </div>
                    </div>
                    <h3>Contract Details</h3>
                    <div class="row">
                            <div class="col-md-5">
                                <h4>Status</h4>
                                <p><strong>Current status: </strong>
                                    <t t-if="account.state == 'open'">
                                        <span class="label label-success"><i class="fa fa-fw fa-check"/> Running</span>
                                    </t>
                                    <t t-if="account.state == 'pending'">
                                        <span class="label label-warning"><i class="fa fa-fw fa-refresh"/> To Renew</span>
                                    </t>
                                    <t t-if="account.state == 'close'">
                                        <span class="label label-default"><i class="fa fa-fw fa-remove"/> Closed</span>
                                    </t>
                                    <t t-if="account.state == 'cancelled'">
                                        <span class="label label-danger"><i class="fa fa-fw fa-ban"/> Cancelled</span>
                                    </t>
                                </p>
                                <p><strong>Valid until: </strong><t t-esc="account.date"/></p>
                                <p><strong>Billing/renewal: </strong>
                                    Every 
                                    <t t-esc="account.recurring_interval"/>
                                    <t t-if="account.recurring_rule_type=='daily'">
                                        day(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='weekly'">
                                        week(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='monthly'">
                                        month(s)
                                    </t>
                                    <t t-if="account.recurring_rule_type=='yearly'">
                                        years(s)
                                    </t>
                                </p>
                                <p><strong>Next invoice date: </strong><t t-esc="account.recurring_next_date"/></p>
                                <br/>

                                <p><strong>Subtotal: </strong>
                                    <span t-field="account.recurring_price" t-field-options='{"widget": "monetary", "display_currency": "account.company_id.currency_id"}'/>
                                </p>
                                <p><strong>Taxes: </strong></p>
                                <p><strong>Total: </strong></p>
                            </div>
                            <div class="col-md-5">
                                <h4>Invoice Address</h4>
                                    <div t-field="account.partner_id" t-field-options='{
                                        "widget": "contact",
                                        "fields": [
                                            "name",
                                            "address",
                                            "phone",
                                            "mobile",
                                            "fax",
                                            "email"]}'/>

                                <h4>Technical Contact</h4>
                                <div t-field="account.manager_id" t-field-options='{
                                        "widget": "contact",
                                        "fields": [
                                            "name",
                                            "address",
                                            "phone",
                                            "email"]}'/>
                            </div>
                    </div>
                    <h3>Your Plan</h3>
                    <div class="row">
                        <t t-set="template" t-value="account.template_id"/>
                        <t t-call="website_contract.template_panel"/>

                        <t t-foreach="account_templates" t-as="template">
                            <t t-if="template.user_selectable and not template.id==account.template_id.id">
                                <t t-call="website_contract.template_panel"/>
                            </t>
                        </t>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h3>Active Options</h3>
                            <div class="panel panel-default">
                                <table class="table table-default">
                                    <tr><th>Option</th><th>Price</th><th>Action</th></tr>
                                    <t t-set="active_options" t-value="True"/>
                                    <t t-foreach="account.template_id.option_invoice_line_ids" t-as="option_line">
                                        <t t-foreach="account.recurring_invoice_line_ids" t-as="inv_line">
                                            <t t-if="option_line.product_id == inv_line.product_id">
                                                <tr>
                                                    <td t-esc="option_line.product_id.name_template"/>
                                                    <td><span t-field="option_line.price_subtotal" t-field-options='{"widget": "monetary", "display_currency": "account.company_id.currency_id"}'/></td>
                                                    <t t-if="active_options and (option_line.portal_access in ['both'])">
                                                        <td><a t-att-href="'/account/contract/'+str(account.id)+'/remove/'+str(inv_line.id)" class="btn btn-danger btn-xs"><i class="fa fa-fw fa-remove"/> Remove</a></td>
                                                    </t>
                                                    <t t-if="option_line.portal_access in ['none', False] or (active_options and option_line.portal_access in ['upgrade'])">
                                                        <td><a href="javascript:alert('Not controller yet')" class="btn btn-primary btn-xs"><i class="fa fa-fw fa-phone"/> Contact Sales</a></td>
                                                    </t>
                                                </tr>
                                            </t>
                                        </t>
                                    </t>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h3>Add Options</h3>
                            <div class="panel panel-default">
                                <table class="table table-default">
                                    <tr><th>Option</th><th>Price</th><th>Action</th></tr>
                                    <t t-foreach="account.template_id.option_invoice_line_ids" t-as="option_line">
                                        <t t-if="option_line.product_id not in [line.product_id for line in account.recurring_invoice_line_ids]">
                                            <tr>
                                                <td t-esc="option_line.product_id.name_template"/>
                                                <td><span t-field="option_line.price_subtotal" t-field-options='{"widget": "monetary", "display_currency": "account.company_id.currency_id"}'/></td>
                                                <t t-if="option_line.portal_access in ['both', 'upgrade']">
                                                    <td><a t-att-href="'/account/contract/'+str(account.id)+'/add/'+str(option_line.id)" class="btn btn-success btn-xs"><i class="fa fa-fw fa-plus-circle"/> Add</a></td>
                                                </t>
                                                <t t-if="option_line.portal_access in ['none', False] or (active_options and option_line.portal_access in ['upgrade'])">
                                                    <td><a href="javascript:alert('Not controller yet')" class="btn btn-primary btn-xs"><i class="fa fa-fw fa-phone"/> Contact Sales</a></td>
                                                </t>
                                            </tr>
                                        </t>
                                    </t>
                                </table>
                            </div>
                        </div>
                    </div>
                    <h3>Terms and conditions</h3>
                    <t t-raw="terms"/>
                </div>
            </div>
        </t>
    </template>

    <template id="template_panel">
        <div class="col-md-3">
            <div t-att-class="'panel panel-primary' if (account.template_id.id == template.id) else 'panel panel-default'">
                <div class="panel-heading">
                    <h3 class="panel-title text-center" t-esc="template.name"/>
                </div>
                <div class="panel-body">
                    <ul class='list-unstyled'>
                        <t t-foreach="template.recurring_invoice_line_ids" t-as="invoice_line">
                            <li t-esc="invoice_line.product_id.name_template"/>
                        </t>
                    </ul>
                    <hr/>
                    <t t-raw="template.plan_description" />
                </div>
                <div class="panel-footer clearfix">
                    <h4 class="pull-right" t-field="template.recurring_price" t-field-options='{"widget": "monetary", "display_currency": "template.company_id.currency_id"}'/>
                    <t t-if="template.user_selectable and account.template_id.id != template.id">
                        <a class="btn btn-primary pull-left" t-att-href="'/account/contract/'+str(account.id)+'/switch/'+str(template.id)"><i class="fa fa-fw fa-arrow-circle-right"></i> Select</a>
                    </t>
                </div>
            </div>
        </div>
    </template>

    <template id="template_option">
        <tr>
            <td t-esc="option_line.product_id.name_template"/>
            <td><span t-field="option_line.price_subtotal" t-field-options='{"widget": "monetary", "display_currency": "account.company_id.currency_id"}'/></td>
            <t t-if="active_options and (option_line.portal_access in ['both'])">
                <td><a t-att-href="'/account/contract/'+str(account.id)+'/remove/'+str(inv_line.id)" class="btn btn-danger btn-xs"><i class="fa fa-fw fa-remove"/> Remove</a></td>
            </t>
            <t t-if="not active_options and (option_line.portal_access in ['both', 'upgrade'])">
                <td><a t-att-href="'/account/contract/'+str(account.id)+'/add/'+str(option_line.id)" class="btn btn-success btn-xs"><i class="fa fa-fw fa-plus-circle"/> Add</a></td>
            </t>
            <t t-if="option_line.portal_access in ['none', False] or (active_options and option_line.portal_access in ['upgrade'])">
                <td><a href="javascript:alert('Not controller yet')" class="btn btn-primary btn-xs"><i class="fa fa-fw fa-phone"/> Contact Sales</a></td>
            </t>
        </tr>
    </template>

<template id="account" name="Account" inherit_id="website_portal.account">
     <xpath expr="//div[@id='documents_list']" position="inside">
        <t t-call="website_contract.contracts" />
    </xpath>
    <xpath expr="//h2[@id='page_subtitle']" position="replace">
        <h2 class="text-center text-muted" id="page_subtitle">Manage your contracts and sales documents</h2>
    </xpath>
</template>


<template id="contracts" name="Contracts">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Your Subscriptions</h3>
            </div>
            <div class="panel-body">
                <t t-if="not cust_accounts">
                    <p>You don't have any subscriptions yet.</p>
                </t>
                <t t-if="cust_accounts">
                    <table class="table table-hover">
                        <thead>
                            <th>Name</th>
                            <th>Payment</th>
                            <th>Status</th>
                        </thead>
                        <t t-foreach="cust_accounts" t-as="account">
                            <tr>
                                <td><a t-att-href="'/account/contract/'+str(account.id)"><t t-esc="account.name"/></a></td>
                                <td><span t-field="account.recurring_price" t-field-options='{"widget": "monetary", "display_currency": "account.company_id.currency_id"}'/></td>
                                <td>
                                    <t t-if="account.state == 'open'">
                                        <span class="label label-success"><i class="fa fa-fw fa-check"/> Running</span>
                                    </t>
                                    <t t-if="account.state == 'pending'">
                                        <span class="label label-warning"><i class="fa fa-fw fa-refresh"/> To Renew</span>
                                    </t>
                                    <t t-if="account.state == 'close'">
                                        <span class="label label-default"><i class="fa fa-fw fa-remove"/> Closed</span>
                                    </t>
                                    <t t-if="account.state == 'cancelled'">
                                        <span class="label label-danger"><i class="fa fa-fw fa-ban"/> Cancelled</span>
                                    </t>
                                </td>
                            </tr>
                        </t>
                    </table>
                </t>
            </div>
        </div>
    </template>
</odoo>